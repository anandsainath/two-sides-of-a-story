{% extends "base.html" %}

{% block header_script %}
<script src="http://d3js.org/d3.v3.min.js"></script>

<style>
	svg {
		font: 10px sans-serif;
	}

	.area, .brect {
		fill: #00A4E4;
		clip-path: url(#clip);
	}

	.bbrect{
		fill: #B30000;
		clip-path: url(#clip);
	}

	.axis path,
	.axis line {
		fill: none;
		stroke: #000;
		shape-rendering: crispEdges;
	}

	.brush .extent {
		stroke: #fff;
		fill-opacity: .125;
		shape-rendering: crispEdges;
	}
</style>
{% endblock %}

{% block content %}
{% endblock %}

{% block content_script %}
<script type="text/javascript">

	var margin = {top: 10, right: 10, bottom: 100, left: 40},
		margin2 = {top: 430, right: 10, bottom: 20, left: 40},
		width = 960 - margin.left - margin.right,
		height = 500 - margin.top - margin.bottom,
		height2 = 500 - margin2.top - margin2.bottom;

	var parseDate = d3.time.format("%Y-%m-%d").parse;

	var x = d3.time.scale().range([0, width]),
		x2 = d3.time.scale().range([0, width]),
		y = d3.scale.sqrt().range([height/2, 0]),
		by = d3.scale.sqrt().range([height/2, height]),
		y2 = d3.scale.sqrt().range([height2/2, 0])
		by2 = d3.scale.sqrt().range([height2/2, height2]);

	var xAxis = d3.svg.axis().scale(x).orient("bottom"),
		xAxis2 = d3.svg.axis().scale(x2).orient("bottom"),
		yAxis = d3.svg.axis().scale(y).orient("left").ticks(4),
		byAxis = d3.svg.axis().scale(by).orient("left").ticks(4);

	var brush = d3.svg.brush()
		.x(x2)
		.on("brush", brushed);


	var svg = d3.select("body").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom);

	svg.append("defs").append("clipPath")
		.attr("id", "clip")
		.append("rect")
		.attr("width", width)
		.attr("height", height);

	var focus = svg.append("g")
		.attr("class", "focus")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var context = svg.append("g")
		.attr("class", "context")
		.attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

	var date1, date2;

	d3.csv("/static/data/output.csv", type, function(error, data) {
		x.domain(d3.extent(data.map(function(d) { return d.date; }))).nice(d3.time.month);
		y.domain([0.1, d3.max([d3.max(data.map(function(d) { return d.liberal; })), d3.max(data.map(function(d) { return d.conservative; }))])]).nice().clamp(true);
		by.domain(y.domain()).nice().clamp(true);
		x2.domain(x.domain()).nice(d3.time.month);
		y2.domain(y.domain()).nice().clamp(true);
		by2.domain(y.domain()).nice().clamp(true);

		var restrictedFocus = focus.append("g")
			.attr("class","area");

		var bar = restrictedFocus.selectAll(".bar")
	    	.data(data)
		  	.enter().append("g")
		    .attr("class", "bar")
		    .attr("transform", function(d) { return "translate(" + x(d.date) + "," + y(d.liberal) + ")"; });

		var bottomBar = restrictedFocus.selectAll(".bbar")
			.data(data).enter()
			.append("g")
			.attr("class","bbar")
			.attr("transform", function(d) { return "translate(" + x(d.date) + ",0)"; });

		date1 = data[0].date;
		date2 = data[1].date;

		bar.append("rect")
			.attr("class","brect")
		    .attr("x", 0)
		    .attr("width", x(date2) - x(date1))
		    .attr("height", function(d) { return (height/2) - y(d.liberal); });

		bottomBar.append("rect")
			.attr("class","bbrect")
			.attr("x", 0)
			.attr("y", height/2)
			.attr("width", x(date2) - x(date1))
		    .attr("height", function(d) { 
		    	return by(d.conservative) - (height/2); 
		    });

		focus.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + height + ")")
			.call(xAxis);

		focus.append("g")
			.attr("class", "y axis")
			.call(yAxis);

		focus.append("g")
			.attr("class", "by axis")
			.call(byAxis);

		var cbar = context.selectAll(".bar")
	    	.data(data)
		  	.enter().append("g")
		    .attr("class", "bar")
		    .attr("transform", function(d) { return "translate(" + x(d.date) + "," + y2(d.liberal) + ")"; });

		var cbottomBar = context.selectAll(".bbar")
			.data(data).enter()
			.append("g")
			.attr("class","bbar")
			.attr("transform", function(d) { return "translate(" + x(d.date) + ",0)"; });

		cbar.append("rect")
			.attr("class","brect")
		    .attr("x", 0)
		    .attr("width", x(date2) - x(date1))
		    .attr("height", function(d) { return (height2/2) - y2(d.liberal); });

		cbottomBar.append("rect")
			.attr("class","bbrect")
			.attr("x", 0)
			.attr("y", height2/2)
			.attr("width", x(date2) - x(date1))
		    .attr("height", function(d) { return by2(d.conservative) - height2/2; });

		context.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + height2 + ")")
			.call(xAxis2);

		context.append("g")
			.attr("class", "x brush")
			.call(brush)
			.selectAll("rect")
			.attr("y", -6)
			.attr("height", height2 + 7);
	});

	function brushed() {
		x.domain(brush.empty() ? x2.domain() : brush.extent());

		focus.selectAll(".bar").attr("transform", function(datum){
			return "translate("+ x(datum.date) + "," + y(datum.liberal) + ")"; 
		});
		focus.selectAll(".brect")
			.attr("width", x(date2) - x(date1))

		focus.selectAll(".bbar").attr("transform", function(datum){
			return "translate("+ x(datum.date) + ",0)"; 
		});
		focus.selectAll(".bbrect")
			.attr("width", x(date2) - x(date1))
		focus.select(".x.axis").call(xAxis);
	}

	function type(d) {
		d.date = parseDate(d.date);
		d.liberal = +d.liberal;
		return d;
	}

</script>
{% endblock %}